<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sarawak Pandai Usage Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        /* Allow natural scrolling for the whole page */
        body { 
            min-height: 100vh;
            overflow-y: auto;
        }

        /* Enforce map height so it doesn't collapse */
        #map { 
            height: 600px; 
            width: 100%; 
            z-index: 1; 
        }

        .stat-card { transition: all 0.3s ease; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        /* Custom Scrollbar for sidebar */
        aside::-webkit-scrollbar { width: 6px; }
        aside::-webkit-scrollbar-track { background: #f1f1f1; }
        aside::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        aside::-webkit-scrollbar-thumb:hover { background: #555; }
        
        /* Table styling */
        #data-table th, #data-table td { 
            padding-left: 1.5rem;
            padding-right: 1.5rem;
        }
        
        /* Custom sorting indicator */
        .sortable { cursor: pointer; user-select: none; }
        .sortable.asc:after { content: " ▲"; }
        .sortable.desc:after { content: " ▼"; }
        
        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5000;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans flex flex-col">

    <!-- Header -->
    <header class="bg-blue-900 text-white p-4 shadow-md flex justify-between items-center z-20 shrink-0">
        <div>
            <h1 class="text-2xl font-bold flex items-center gap-2">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.[...]"/></svg>
                Sarawak Pandai Dashboard
            </h1>
            <p class="text-blue-200 text-base">Visualization of Student & Teacher distribution in Sarawak</p>
        </div>
        <div class="flex gap-3 items-center">
             <!-- Update Data Button -->
             <button id="open-data-modal-button" class="px-4 py-2 bg-blue-700 text-white font-semibold rounded-lg hover:bg-blue-600 transition flex items-center gap-2 text-sm shadow-md">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1[...]"/></svg>
                Settings & Data
             </button>
             
             <div class="text-right text-sm">
                 <span id="total-schools-badge" class="bg-blue-700 px-3 py-1 rounded-full">0 Schools</span>
                 <span id="total-users-badge" class="bg-green-600 px-3 py-1 rounded-full">0 Users</span>
             </div>
        </div>
    </header>
    
    <!-- Key Metrics Panel -->
    <div id="key-metrics-panel" class="bg-white p-4 shadow-md border-b border-gray-200 z-10 shrink-0">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <!-- Metrics -->
            <div class="stat-card bg-indigo-50 p-3 rounded border border-indigo-100">
                <div class="text-xs text-indigo-500 uppercase font-bold">Students</div>
                <div id="stat-students" class="text-4xl font-bold text-indigo-800">0</div>
            </div>
            <div class="stat-card bg-orange-50 p-3 rounded border border-orange-100">
                <div class="text-xs text-orange-500 uppercase font-bold">Teachers</div>
                <div id="stat-teachers" class="text-4xl font-bold text-orange-800">0</div>
            </div>
            <div class="stat-card bg-emerald-50 p-3 rounded border border-emerald-100">
                <div class="text-xs text-emerald-500 uppercase font-bold">Total Active Users</div>
                <div id="stat-total" class="text-4xl font-bold text-emerald-800">0</div>
            </div>
            
            <!-- Top 10 Cities -->
            <div class="md:col-span-1 bg-gray-50 p-3 rounded border border-gray-100 flex flex-col">
                <div id="top-cities-label" class="text-xs text-gray-500 uppercase font-bold mb-2">Top 10 Cities By All Users</div>
                <div class="flex bg-gray-200 rounded p-0.5 mb-2">
                    <label class="flex-1 text-center cursor-pointer">
                        <input type="radio" name="top10-city-mode" value="all" class="hidden peer" checked>
                        <span class="block text-sm py-1 rounded peer-checked:bg-white peer-checked:shadow peer-checked:font-bold peer-checked:text-emerald-600 transition">All</span>
                    </label>
                    <label class="flex-1 text-center cursor-pointer">
                        <input type="radio" name="top10-city-mode" value="students" class="hidden peer">
                        <span class="block text-sm py-1 rounded peer-checked:bg-white peer-checked:shadow peer-checked:font-bold peer-checked:text-indigo-600 transition">Students</span>
                    </label>
                    <label class="flex-1 text-center cursor-pointer">
                        <input type="radio" name="top10-city-mode" value="teachers" class="hidden peer">
                        <span class="block text-sm py-1 rounded peer-checked:bg-white peer-checked:shadow peer-checked:font-bold peer-checked:text-orange-600 transition">Teachers</span>
                    </label>
                </div>
                <div id="top-cities-list" class="space-y-1 text-sm overflow-y-auto max-h-32"></div>
            </div>

            <!-- Top 10 Schools -->
            <div class="md:col-span-1 bg-gray-50 p-3 rounded border border-gray-100 flex flex-col">
                <div id="top-schools-label" class="text-xs text-gray-500 uppercase font-bold mb-2">Top 10 Schools by All Users</div>
                <div class="flex bg-gray-200 rounded p-0.5 mb-2">
                    <label class="flex-1 text-center cursor-pointer">
                        <input type="radio" name="top10-school-mode" value="all" class="hidden peer" checked>
                        <span class="block text-sm py-1 rounded peer-checked:bg-white peer-checked:shadow peer-checked:font-bold peer-checked:text-emerald-600 transition">All</span>
                    </label>
                    <label class="flex-1 text-center cursor-pointer">
                        <input type="radio" name="top10-school-mode" value="students" class="hidden peer">
                        <span class="block text-sm py-1 rounded peer-checked:bg-white peer-checked:shadow peer-checked:font-bold peer-checked:text-indigo-600 transition">Students</span>
                    </label>
                    <label class="flex-1 text-center cursor-pointer">
                        <input type="radio" name="top10-school-mode" value="teachers" class="hidden peer">
                        <span class="block text-sm py-1 rounded peer-checked:bg-white peer-checked:shadow peer-checked:font-bold peer-checked:text-orange-600 transition">Teachers</span>
                    </label>
                </div>
                <div id="top-schools-list" class="space-y-1 text-sm overflow-y-auto max-h-32"></div>
            </div>
        </div>
    </div>

    <!-- Main Content Area (Map + Sidebar) - REMOVED h-screen/overflow-hidden constraints -->
    <div class="flex flex-col md:flex-row w-full">
        
        <!-- Sidebar Controls -->
        <aside class="w-full md:w-80 bg-white shadow-lg z-10 flex flex-col border-r border-gray-200 shrink-0">
            <div class="p-5 space-y-5">
                <!-- Search -->
                <div>
                    <label class="block text-sm font-bold text-gray-500 uppercase mb-1">Search School</label>
                    <input type="text" id="search-input" placeholder="e.g. SMK Pujut" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500 te[...]"/>
                </div>

                <!-- Filters -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-bold text-gray-500 uppercase mb-1">School Type</label>
                        <select id="type-filter" class="w-full px-2 py-2 border border-gray-300 rounded text-base focus:ring-2 focus:ring-blue-500">
                            <option value="all">All Types</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-500 uppercase mb-1">City</label>
                        <select id="city-filter" class="w-full px-2 py-2 border border-gray-300 rounded text-base focus:ring-2 focus:ring-blue-500">
                            <option value="all">All Cities</option>
                        </select>
                    </div>
                </div>

                <!-- Data Toggle -->
                <div>
                    <label class="block text-sm font-bold text-gray-500 uppercase mb-2">Data Source</label>
                    <div class="flex bg-gray-200 rounded p-1">
                        <label class="flex-1 text-center cursor-pointer">
                            <input type="radio" name="data-mode" value="teachers" class="hidden peer">
                            <span class="block text-sm py-1.5 rounded peer-checked:bg-white peer-checked:shadow peer-checked:font-bold peer-checked:text-orange-600 transition">Teachers</span>
                        </label>
                        <label class="flex-1 text-center cursor-pointer">
                            <input type="radio" name="data-mode" value="students" class="hidden peer">
                            <span class="block text-sm py-1.5 rounded peer-checked:bg-white peer-checked:shadow peer-checked:font-bold peer-checked:text-indigo-600 transition">Students</span>
                        </label>
                        <label class="flex-1 text-center cursor-pointer">
                            <input type="radio" name="data-mode" value="all" class="hidden peer" checked>
                            <span class="block text-sm py-1.5 rounded peer-checked:bg-white peer-checked:shadow peer-checked:font-bold peer-checked:text-emerald-600 transition">All</span>
                        </label>
                    </div>
                </div>

                <!-- Visualization Toggle -->
                <div>
                    <label class="block text-sm font-bold text-gray-500 uppercase mb-2">Visualization Mode</label>
                    <div class="flex items-center justify-between border p-2 rounded bg-white">
                        <span class="text-base text-gray-600">Cluster Markers</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="vis-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:[...]"/>
                        </label>
                        <span class="text-base text-gray-600">Heatmap</span>
                    </div>
                </div>
                
                <!-- LLM Strategic Query Tool -->
                <div class="pt-4 border-t border-gray-200">
                    <h4 class="font-semibold text-gray-700 mb-2 text-base flex items-center gap-1">
                        <svg class="w-4 h-4 text-violet-600" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414[...]"/></svg>
                        Strategic Query Tool
                    </h4>
                    <p class="text-xs text-gray-500 mb-2">Requires Gemini API Key in Settings</p>
                    <textarea id="llm-query-input" rows="3" placeholder="E.g., Which cities show high student engagement but low teacher count?" class="w-full p-2 border border-gray-300 rounded t[...]"/></textarea>
                    <button id="ai-query-button" class="w-full px-3 py-3 bg-violet-600 text-white font-bold rounded-lg hover:bg-violet-700 transition flex items-center justify-center gap-2">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 20v[...]"/></svg>
                        Get Strategic Insight
                    </button>
                </div>
            </div>
        </aside>

        <!-- Map Container (Right Side) -->
        <main class="flex-1 relative">
            <div id="map" class="w-full"></div>
            
            <!-- Legend Overlay -->
            <div id="heatmap-legend" class="hidden absolute bottom-8 right-8 bg-white p-3 rounded shadow-lg z-[1000] border border-gray-200">
                <div class="text-sm font-bold mb-2">User Density</div>
                <div class="h-2 w-32 bg-gradient-to-r from-yellow-100 via-yellow-400 to-green-900 rounded"></div>
                <div class="flex justify-between text-xs mt-1 text-gray-500">
                    <span>Low</span>
                    <span>High</span>
                </div>
            </div>
        </main>
    </div>

    <!-- Data Table Section -->
    <div id="data-table-container" class="p-4 bg-white shadow-lg mx-4 mb-4 rounded-lg mt-4">
        <h3 class="text-xl font-semibold text-gray-700 mb-4">Detailed School Data (<span id="table-mode-label">All Users</span>)</h3>
        
        <!-- Pagination Controls -->
        <div class="flex justify-between items-center mb-4">
            <div class="text-sm text-gray-700">
                Showing <span id="pagination-start">0</span> to <span id="pagination-end">0</span> of <span id="pagination-total">0</span> entries
            </div>
            <div class="flex items-center space-x-4">
                <label class="text-sm text-gray-700">Per Page:</label>
                <select id="page-size" class="px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500">
                    <option value="10">10</option>
                    <option value="30">30</option>
                    <option value="50">50</option>
                </select>
                <div class="flex space-x-1">
                    <button id="prev-page" class="px-3 py-1 bg-gray-200 text-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed">&larr; Prev</button>
                    <span id="current-page-display" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">1</span>
                    <button id="next-page" class="px-3 py-1 bg-gray-200 text-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed">Next &rarr;</button>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto border rounded-lg">
            <table id="data-table" class="min-w-full divide-y divide-gray-200"></table>
        </div>
        
        <div class="flex justify-center items-center mt-4">
            <div class="flex items-center space-x-4">
                <div class="flex space-x-1">
                    <button id="prev-page-bottom" class="px-3 py-1 bg-gray-200 text-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed">&larr; Prev</button>
                    <span id="current-page-display-bottom" class="px-3 py-1 bg-blue-500 text-white rounded text-sm">1</span>
                    <button id="next-page-bottom" class="px-3 py-1 bg-gray-200 text-gray-700 rounded disabled:opacity-50 disabled:cursor-not-allowed">Next &rarr;</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Management Modal -->
    <div id="data-management-modal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-md w-11/12 transform transition-transform duration-300">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317[...]"/></svg>
                    Settings & Data
                </h2>
                <button id="close-data-modal-button" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></pat[...]"/></svg>
                </button>
            </div>

            <!-- API Key Section -->
             <div class="mb-6 p-3 bg-violet-50 border border-violet-100 rounded-lg">
                <h4 class="font-semibold text-violet-800 mb-1 text-sm">Gemini API Configuration</h4>
                <p class="text-xs text-gray-600 mb-2">Required for the Strategic Query Tool to work.</p>
                <div class="flex gap-2">
                    <input type="password" id="api-key-input" placeholder="Paste your Google Gemini API Key here" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none[...]"/>
                    <button id="save-api-key-button" class="px-3 py-2 bg-violet-600 text-white text-sm font-bold rounded hover:bg-violet-700 transition">Save Key</button>
                </div>
            </div>

            <div class="space-y-4 mb-6 border-t pt-4">
                <h4 class="font-semibold text-gray-700 mb-2 text-base">Data Upload</h4>
                <p class="text-xs text-gray-600">Upload new CSV files to temporarily update the dashboard view.</p>
                <div>
                    <label class="block text-gray-500 mb-1 font-semibold text-sm">1. Update Students CSV</label>
                    <input type="file" id="student-upload-modal" accept=".csv" class="block w-full text-gray-500 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:fo[...]"/>
                </div>
                <div>
                    <label class="block text-gray-500 mb-1 font-semibold text-sm">2. Update Teachers CSV</label>
                    <input type="file" id="teacher-upload-modal" accept=".csv" class="block w-full text-gray-500 file:mr-4 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:fo[...]"/>
                </div>
            </div>

            <div class="pt-4 border-t border-gray-200">
                <h4 class="font-semibold text-gray-700 mb-2 text-base">3. Hardcode Data (Requires Password)</h4>
                <p class="text-xs text-red-500 mb-2">Warning: This overwrites the default data inside the HTML file.</p>
                <input type="password" id="save-password-modal" placeholder="Enter secret password" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ri[...]"/>
                <button id="save-data-button-modal" class="w-full px-3 py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition">
                    Save Data to Code
                </button>
            </div>
        </div>
    </div>


    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="assets/marker-user-counts.js"></script>

    <script>
        /**
         * 1. DEFAULT DATA
         */
        let defaultStudentCSV = `school_name,school_type,postcode,city,state_name,total_users
"SEKOLAH MENENGAH KEBANGSAAN TEMENGGONG DATUK LAWAI JAU",SM KEBANGSAAN,,MARUDI,Sarawak,464
"SEKOLAH MENENGAH KEBANGSAAN PUJUT",SM KEBANGSAAN,,MIRI,Sarawak,391
"SEKOLAH MENENGAH KEBANGSAAN BINTULU",SM KEBANGSAAN,,BINTULU,Sarawak,372
...`